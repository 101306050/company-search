<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公司案件進度查詢 (進階版)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .container { max-width: 800px; margin-top: 3rem; }
        .card-header { background-color: #007bff; color: white; }
        .loading-spinner { width: 1.5rem; height: 1.5rem; }
        #resultsTable th { background-color: #f2f2f2; position: sticky; top: 0; }
        .form-label { margin-bottom: 0.25rem; font-size: 0.9rem; color: #555; }
        .scan-result-title {
            padding: 0.5rem 1rem;
            background-color: #e9ecef;
            font-weight: bold;
            margin-top: 1.5rem;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card shadow-sm">
            <div class="card-header">
                <h2>商工案件進度查詢</h2>
            </div>
            <div class="card-body p-4">
                <div class="row g-3 align-items-end">
                    <div class="col-md-7">
                        <label for="queryInput" class="form-label">公司名稱或統一編號</label>
                        <input type="text" class="form-control form-control-lg" id="queryInput" placeholder="輸入查詢內容">
                    </div>
                    <div class="col-md-5">
                        <label for="agencySelect" class="form-label">申登機關</label>
                        <select id="agencySelect" class="form-select form-select-lg">
                            <!-- 選項將由 JS 動態生成 -->
                        </select>
                    </div>
                </div>
                <div class="d-grid mt-3">
                    <button class="btn btn-primary btn-lg" type="button" id="searchBtn">
                        <span id="searchBtnText">查詢</span>
                        <div class="spinner-border loading-spinner d-none" role="status" id="loadingSpinner">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
        <div id="resultsContainer" class="mt-4"></div>
    </div>

    <script>
        const queryInput = document.getElementById('queryInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchBtnText = document.getElementById('searchBtnText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsContainer = document.getElementById('resultsContainer');
        const agencySelect = document.getElementById('agencySelect');

        // 機關代碼列表 (從政府網站取得，並加入「全部」選項)
        const agencies = {
            "all": "全部機關 (自動掃描)",
            "00": "經濟部商業發展署",
            "62": "臺北市政府",
            "64": "高雄市政府",
            "65": "新北市政府",
            "66": "臺中市政府",
            "67": "臺南市政府",
            "68": "桃園市政府",
            "01": "基隆市政府",
            "02": "新竹市政府",
            "04": "嘉義市政府",
            "14": "宜蘭縣政府",
            "03": "新竹縣政府",
            "15": "桃園縣政府",
            "05": "苗栗縣政府",
            "17": "彰化縣政府",
            "06": "南投縣政府",
            "07": "雲林縣政府",
            "18": "嘉義縣政府",
            "10": "屏東縣政府",
            "08": "花蓮縣政府",
            "11": "臺東縣政府",
            "12": "澎湖縣政府",
            "20": "金門縣政府",
            "21": "連江縣政府",
            "09": "經濟部產業園區管理局",
            "A1": "國家科學及技術委員會新竹科學園區管理局",
            "B1": "國家科學及技術委員會中部科學園區管理局",
            "C1": "國家科學及技術委員會南部科學園區管理局",
            "E1": "屏東農業生物技術園區"
        };
        
        // 動態生成下拉選單
        function populateAgencies() {
            for (const code in agencies) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = agencies[code];
                agencySelect.appendChild(option);
            }
        }

        async function performSearch() {
            const query = queryInput.value.trim();
            if (!query) {
                alert('請輸入查詢內容');
                return;
            }

            searchBtn.disabled = true;
            searchBtnText.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');
            resultsContainer.innerHTML = `<p class="text-center">查詢中，若選擇「全部機關」可能需要較長時間，請耐心等候...</p>`;

            const selectedAgency = agencySelect.value;

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&agency=${selectedAgency}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `伺服器錯誤: ${response.statusText}`);
                }
                const results = await response.json();
                displayResults(results);
            } catch (error) {
                resultsContainer.innerHTML = `<div class="alert alert-danger">查詢失敗：${error.message}</div>`;
            } finally {
                searchBtn.disabled = false;
                searchBtnText.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');
            }
        }

        function displayResults(data) {
            if (data.error) {
                resultsContainer.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                return;
            }
            // 如果是全部掃描模式，data.results 是一個物件
            if (data.isScan) {
                 let finalHTML = '';
                 let found = false;
                 for(const agencyCode in data.results) {
                     const resultForAgency = data.results[agencyCode];
                     if(resultForAgency.cases && resultForAgency.cases.length > 0){
                         found = true;
                         finalHTML += `<h4 class="scan-result-title">${agencies[agencyCode]}</h4>`;
                         finalHTML += createTableHTML(resultForAgency);
                     }
                 }
                 if(!found) {
                     resultsContainer.innerHTML = `<div class="alert alert-info">掃描完畢，在所有機關中均查無相關案件資料。</div>`;
                 } else {
                     resultsContainer.innerHTML = finalHTML;
                 }
            } else { // 單一機關查詢，data 是單一結果物件
                if (!data.cases || data.cases.length === 0) {
                    resultsContainer.innerHTML = `<div class="alert alert-info">在「${agencies[data.agency]}」查無相關案件資料。</div>`;
                } else {
                    resultsContainer.innerHTML = createTableHTML(data);
                }
            }
        }

        function createTableHTML(data) {
             let tableHTML = `
                <div class="card mb-3">
                    <div class="card-header">查詢結果：${data.companyName || 'N/A'} (${data.companyUBN || 'N/A'})</div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0" id="resultsTable">
                            <thead><tr><th>收文日期</th><th>收文號</th><th>案件名稱</th><th>辦理機關</th><th>目前狀態</th></tr></thead>
                            <tbody>`;
            data.cases.forEach(c => {
                tableHTML += `<tr>
                    <td>${c.date}</td>
                    <td>${c.caseNumber}</td>
                    <td>${c.caseName}</td>
                    <td>${c.agency}</td>
                    <td><strong>${c.status}</strong></td>
                </tr>`;
            });
            tableHTML += `</tbody></table></div></div>`;
            return tableHTML;
        }

        document.addEventListener('DOMContentLoaded', populateAgencies);
        searchBtn.addEventListener('click', performSearch);
        queryInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
        agencySelect.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });

    </script>
</body>
</html>
